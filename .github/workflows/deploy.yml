# ============================================================================
# GitHub Actions Workflow - Deploy Medical Data Pipeline
# ============================================================================
# This workflow automates deployment to AWS:
# 1. Terraform Apply Infrastructure (ECR, S3, Lambda roles, etc.)
# 2. Build & Push Docker Images to ECR
# 3. Optionally update Lambda with new images
# ============================================================================

name: Deploy to AWS

on:
  push:
    branches:
      - main        # Production deployment
      - develop     # Development deployment
  pull_request:
    branches:
      - main

env:
  AWS_REGION: eu-central-1
  PROJECT_NAME: medical-data-pipeline
  TERRAFORM_VERSION: 1.6.0

jobs:
  # ==========================================================================
  # Job 1: Terraform Apply Infrastructure
  # ==========================================================================
  terraform-apply:
    name: Terraform Apply Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          # Uncomment the next line if using remote backend
          #terraform init -backend-config=backend.conf
          terraform init

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve \
            -var="lambda_image_tag=${{ github.sha }}"

      - name: Save Terraform Outputs
        id: terraform-outputs
        run: |
          echo "api_url=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "s3_bucket=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT

  # ==========================================================================
  # Job 2: Build and Push Docker Images
  # ==========================================================================
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: terraform-apply   # Important: ensures infra exists first
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Metadata
        id: meta
        run: |
          echo "tags=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Build and Push - Conversion Lambda
        uses: docker/build-push-action@v5
        with:
          context: ./functions/conversion
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}-conversion-lambda:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}-conversion-lambda:latest

      - name: Build and Push - Glue Catalog Lambda
        uses: docker/build-push-action@v5
        with:
          context: ./functions/glue_catalog
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}-glue-catalog-lambda:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}-glue-catalog-lambda:latest

      - name: Build and Push - Query Lambda
        uses: docker/build-push-action@v5
        with:
          context: ./functions/query
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}-query-lambda:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}-query-lambda:latest

      - name: Docker Push Summary
        run: |
          echo "### Docker Images Built and Pushed Successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "- Conversion Lambda: `${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}-conversion-lambda:${{ github.sha }}`" >> $GITHUB_STEP_SUMMARY
          echo "- Glue Catalog Lambda: `${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}-glue-catalog-lambda:${{ github.sha }}`" >> $GITHUB_STEP_SUMMARY
          echo "- Query Lambda: `${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}-query-lambda:${{ github.sha }}`" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Job 3: Deployment Summary
  # ==========================================================================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "**API Gateway URL:** `${{ needs.terraform-apply.outputs.api_url }}`" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Data Bucket:** `${{ needs.terraform-apply.outputs.s3_bucket }}`" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Image Tag:** `${{ github.sha }}`" >> $GITHUB_STEP_SUMMARY
          echo "### Test the API" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl \"${{ needs.terraform-apply.outputs.api_url }}?query=SELECT%20*%20FROM%20medical_records%20LIMIT%2010\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
